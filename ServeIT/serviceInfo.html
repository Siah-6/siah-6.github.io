<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ServeIT | Service Info</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="assets/css/nav/nav.css">
    <link rel="icon" href="assets/images/nav/logo-nav.png">
    <link rel="stylesheet" href="assets/css/services/serviceInfo.css">
    <link rel="stylesheet" href="assets/css/footer/footer.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        .active2 {
            color: #19afa5 !important;
        }

        body.dark-mode .active2 {
            color: #19afa5 !important;
        }
    </style>
</head>

<body>
    <div id="nav-container"></div>

    <div class="container my-5">
        <div class="row align-items-center">
            <div class="col">
                <div class="row justify-content-center">
                    <div class="col-lg-6">
                        <div class="imageContainer">
                            <div class="row">
                                <div class="col d-flex justify-content-center align-items-center">
                                    <div class="imageCard">
                                        <img src="assets/images/items/default-service.jpg"
                                            alt="Service Image" id="service-image">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 d-flex align-items-center text-start">
                        <div class="serviceInfo">
                            <h1 class="productTitleInfo pt-1" style="font-size: 32px;" id="service-title">
                                Loading...
                            </h1>
                            <p style="font-size: 14px;" id="service-short-description">Loading...</p>
                            <p class="reviewStars" id="service-rating">
                                <!-- Rating will be dynamically inserted here -->
                            </p>
                            <div class="price fw-bold">
                                <span style="font-size: 32px;" id="service-price">₱0</span><span>.00</span>
                            </div>
                            <div style="border-top: 2px solid #19AFA5; width: 100%; margin: 10px 0; "></div>
                            <h4 class="productDescriptionTitle fw-bold" style="font-size: 16;">SERVICE DESCRIPTION</h4>
                            <p class="productDescriptionInfo" style="font-size: 14px;" id="service-description">
                                Loading...
                            </p>
                            <div class="productButtons">
                                <button class="btnAddCart rounded-pill" style="font-size: 14px;" id="add-to-cart-btn">
                                    ADD TO CART
                                </button>
                                <button class="btnBuyNow rounded-pill" style="font-size: 14px;" id="buy-now-btn">
                                    BUY NOW
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="line-divider">
        </div>
    </div>

    <div class="container mb-5">
        <div class="row">
            <div class="col-12 mb-4">
                <h2 class="productFeedbackTitle fw-bold">SERVICE FEEDBACK</h2>
            </div>
            <div class="col-12">
                <div class="feedbackCardContainer d-flex">
                    <div class="row justify-content-center g-4 w-100">
                        <div class="col-lg-4 col-md-6 col-12">
                            <div class="feedbackCard">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="row-6">
                                            <div class="profilePicture">
                                                <img src="assets/images/uploads/default.png"
                                                    alt="User Profile" id="user-profile-image">
                                            </div>
                                            <div class="username" id="user-username">Loading...</div>
                                        </div>
                                        <div class="row-6">
                                            <input type="text" class="feedbackInput form-control" id="feedback-input"
                                                placeholder="Share feedback..." />
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <input type="hidden" id="rating-value">
                                        <p class="stars" id="rating-stars">
                                            <i class="fa-solid fa-star" data-value="1" onclick="setRating(1)"></i>
                                            <i class="fa-solid fa-star" data-value="2" onclick="setRating(2)"></i>
                                            <i class="fa-solid fa-star" data-value="3" onclick="setRating(3)"></i>
                                            <i class="fa-solid fa-star" data-value="4" onclick="setRating(4)"></i>
                                            <i class="fa-solid fa-star" data-value="5" onclick="setRating(5)"></i>
                                        </p>
                                        <button class="btnAddFeedback rounded-pill" id="add-feedback-btn">
                                            Add Feedback
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="existing-feedback-container">
                            <!-- Existing feedback will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="line-divider">
        </div>
    </div>

    <div class="container mt-3">
        <div class="row d-flex flex-row justify-content-center align-items-center">
            <div class="col-12 mb-3">
                <h2 class="moreservicesTitle text-start fw-bold">MORE SERVICES</h2>
            </div>
            <div class="row" id="more-services-container">
                <!-- More services will be dynamically inserted here -->
            </div>
            <div class="d-flex justify-content-center mb-4">
                <a href="services.html">
                    <button class="btnMoreServices rounded-pill">More Services</button>
                </a>
            </div>
        </div>
    </div>

    <div id="smpayment-container"></div>
    <div id="footer-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.min.js"></script>
    <script>
        new WOW({
            offset: 200,
            mobile: true,
        }).init();
    </script>

    <script src="js/data.js"></script>
    <script src="js/session.js"></script>
    <script src="js/main.js"></script>
    <script>
        let currentService = null;
        let currentUser = null;
        let userFeedbacks = [];

        // Get service ID from URL
        function getServiceIDFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('itemID');
        }

        // Load service details
        function loadServiceDetails() {
            const serviceID = getServiceIDFromURL();
            
            if (!serviceID) {
                window.location.href = 'services.html';
                return;
            }

            currentService = getItemById(serviceID);
            
            if (!currentService || currentService.type !== 'service') {
                window.location.href = 'services.html';
                return;
            }

            renderServiceDetails();
            loadMoreServices();
            loadExistingFeedback();
        }

        // Render service details
        function renderServiceDetails() {
            document.getElementById('service-image').src = `assets/images/items/${currentService.attachment}`;
            document.getElementById('service-title').textContent = currentService.title;
            document.getElementById('service-short-description').textContent = currentService.shortDescription;
            document.getElementById('service-price').textContent = `₱${currentService.price}`;
            document.getElementById('service-description').textContent = currentService.description;

            // Load rating
            loadServiceRating();
            
            // Check if already in cart
            checkCartStatus();
        }

        // Load service rating
        function loadServiceRating() {
            const feedbacks = getFeedbacks().filter(f => f.itemID == currentService.itemID);
            
            if (feedbacks.length === 0) {
                document.getElementById('service-rating').innerHTML = '<span class="rating-value ms-2" style="font-size: 14px;">No Reviews</span>';
                return;
            }

            const averageRating = feedbacks.reduce((sum, f) => sum + f.rating, 0) / feedbacks.length;
            const roundedRating = Math.round(averageRating * 10) / 10;
            const filledStars = Math.floor(roundedRating);
            const halfStar = (roundedRating - filledStars) >= 0.5;

            let starsHTML = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= filledStars) {
                    starsHTML += '<i class="fa-solid fa-star" style="color: #19AFA5;"></i>';
                } else if (halfStar && i === filledStars + 1) {
                    starsHTML += '<i class="fa-solid fa-star-half-stroke" style="color: #19AFA5;"></i>';
                } else {
                    starsHTML += '<i class="fa-regular fa-star"></i>';
                }
            }
            starsHTML += `<span class="rating-value ms-2" style="font-size: 14px;">${feedbacks.length} Reviews</span>`;
            
            document.getElementById('service-rating').innerHTML = starsHTML;
        }

        // Check cart status
        function checkCartStatus() {
            const cart = JSON.parse(localStorage.getItem('serveit_cart') || '[]');
            const inCart = cart.some(item => item.itemID == currentService.itemID);
            
            const addBtn = document.getElementById('add-to-cart-btn');
            if (inCart) {
                addBtn.disabled = true;
                addBtn.textContent = 'ALREADY IN CART';
            }
        }

        // Load more services
        function loadMoreServices() {
            const container = document.getElementById('more-services-container');
            const moreServices = getServices().filter(s => s.itemID != currentService.itemID).slice(0, 8);
            
            container.innerHTML = moreServices.map(service => `
                <div class="col-lg-3 col-6 d-flex flex-row justify-content-center">
                    <div class="serviceCard rounded mx-auto">
                        <div class="card-body d-flex flex-column justify-content-between align-items-center">
                            <div class="serviceImage">
                                <img src="assets/images/items/${service.attachment}"
                                    alt="${service.title}">
                            </div>
                            <div class="w-100 d-flex justify-content-between align-items-center">
                                <span class="serviceTitle">${service.title}</span>
                                <span class="servicePrice">₱${service.price}</span>
                            </div>
                            <div class="w-100 d-flex justify-content-between align-items-center">
                                <p class="serviceDescription">${service.shortDescription}</p>
                                <a href="serviceInfo.html?itemID=${service.itemID}">
                                    <button class="btnSeeMore rounded-pill">See More</button>
                                </a>
                            </div>
                            <div class="line" style="border-top: 2px solid black; width: 100%; margin: 10px 0;"></div>
                            <div class="category">
                                <span>${service.categoryName}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Load existing feedback
        function loadExistingFeedback() {
            const container = document.getElementById('existing-feedback-container');
            const feedbacks = getFeedbacks().filter(f => f.itemID == currentService.itemID);
            
            if (feedbacks.length === 0) {
                container.innerHTML = `
                    <div class="col-lg-4 col-md-6 col-12">
                        <div class="feedbackCard">
                            <div class="text-center py-4">
                                <p>No feedback yet. Be the first to share your experience!</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = feedbacks.map(feedback => {
                const user = getUserById(feedback.userID) || { username: 'Anonymous', profilePicture: 'default.png' };
                return `
                    <div class="col-lg-4 col-md-6 col-12">
                        <div class="feedbackCard">
                            <div class="row">
                                <div class="col-6">
                                    <div class="profilePicture">
                                        <img src="assets/images/uploads/${user.profilePicture}"
                                            alt="${user.username}">
                                    </div>
                                    <div class="username">${user.username}</div>
                                    <p class="feedbackText">${feedback.comment}</p>
                                </div>
                                <div class="col-6">
                                    <p class="stars">
                                        ${generateStars(feedback.rating)}
                                    </p>
                                    <p class="feedbackDate mb-0">
                                        ${new Date(feedback.date).toLocaleDateString()}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Generate star rating HTML
        function generateStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<i class="fa-solid fa-star" style="color: #19AFA5;"></i>';
                } else {
                    stars += '<i class="fa-solid fa-star" style="color: black;"></i>';
                }
            }
            return stars;
        }

        // Rating functionality
        function setRating(rating) {
            const ratingInput = document.getElementById('rating-value');
            const currentRating = parseInt(ratingInput.value);
            const newRating = currentRating === rating ? 0 : rating;
            ratingInput.value = newRating;

            const stars = document.querySelectorAll('#rating-stars i');
            stars.forEach((star, index) => {
                if (index < newRating) {
                    star.style.color = '#19AFA5';
                } else {
                    star.style.color = 'black';
                }
            });
        }

        // Add to cart functionality
        function addToCart() {
            if (!sessionManager.isLoggedIn()) {
                alert('Please log in to add items to cart.');
                window.location.href = 'login.html';
                return;
            }

            const cart = JSON.parse(localStorage.getItem('serveit_cart') || '[]');
            const existingItem = cart.find(item => item.itemID == currentService.itemID);
            
            if (!existingItem) {
                cart.push({
                    itemID: currentService.itemID,
                    title: currentService.title,
                    price: currentService.price,
                    attachment: currentService.attachment,
                    quantity: 1,
                    type: currentService.type
                });
                
                localStorage.setItem('serveit_cart', JSON.stringify(cart));
                alert('Service added to cart successfully!');
                checkCartStatus();
            }
        }

        // Buy now functionality
        function buyNow() {
            addToCart();
            window.location.href = 'cart.html';
        }

        // Add feedback functionality
        function addFeedback() {
            if (!sessionManager.isLoggedIn()) {
                alert('Please log in to add feedback.');
                window.location.href = 'login.html';
                return;
            }

            const feedbackText = document.getElementById('feedback-input').value.trim();
            const rating = document.getElementById('rating-value').value;

            if (!feedbackText || !rating) {
                alert('Please provide both feedback and rating.');
                return;
            }

            // Check if user already gave feedback
            const existingFeedback = userFeedbacks.find(f => f.itemID == currentService.itemID);
            if (existingFeedback) {
                alert('You have already given feedback for this service.');
                return;
            }

            // Add feedback (in real app, this would be saved to database)
            const newFeedback = {
                feedbackID: userFeedbacks.length + 1,
                userID: currentUser.userID,
                itemID: currentService.itemID,
                rating: parseInt(rating),
                comment: feedbackText,
                date: new Date().toISOString()
            };

            userFeedbacks.push(newFeedback);
            
            // Reset form
            document.getElementById('feedback-input').value = '';
            document.getElementById('rating-value').value = '';
            setRating(0);
            
            // Reload feedback
            loadExistingFeedback();
            loadServiceRating();
            
            alert('Feedback added successfully!');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            sessionManager.requireAuth();
            
            // Get current user
            currentUser = sessionManager.getCurrentUser();
            
            // Load service details
            loadServiceDetails();

            // Load navigation and footer
            loadNavigation();
            loadFooter();
            loadSMPayment();

            // Setup event listeners
            document.getElementById('add-to-cart-btn').addEventListener('click', addToCart);
            document.getElementById('buy-now-btn').addEventListener('click', buyNow);
            document.getElementById('add-feedback-btn').addEventListener('click', addFeedback);
        });
    </script>
</body>

</html>
