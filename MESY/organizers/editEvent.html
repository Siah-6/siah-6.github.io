<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Edit Event</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/eventForm.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="icon" href="../assets/img/logo.svg" type="image/x-icon">
</head>

<body>

    <!-- Organizer Navigation Bar (exact copy from PHP) -->
    <style>
        a {
            text-decoration: none;
        }

        .navbar {
            background-color: #FE5722;
        }

        .border-active {
            border-color: #FE5722 !important;
        }
    </style>

    <nav class="navbar navbar-expand-lg p-2 position-relative z-1">
        <div class="container-fluid">
            <div class="w-100 d-flex align-items-center justify-content-between">

                <button class="btn text-dark fs-3 ms-3" data-bs-toggle="offcanvas" data-bs-target="#sideNavbar"
                    aria-controls="sideNavbar">
                    &#9776;
                </button>

                <div class="position-absolute start-50 translate-middle-x d-flex align-items-center gap-2">
                    <img src="../assets/img/logo.svg" alt="logo" style="height: 60px;">
                </div>

                <div class="d-flex align-items-center gap-2 me-3">

                    <a href="eventForm.html">
                        <button class="btn btn-md p-2 rounded-3 ps-3 pe-3 d-none d-lg-inline text-white"
                            style="background-color: #E7400C;">Add
                            Event
                        </button>
                    </a>
                    <a href="#" onclick="logout()" class="btn btn-md p-2 rounded-3 ps-3 pe-3 d-none d-lg-inline"
                        style="background-color: #D9D9D9;">
                        Log Out
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="sideNavbar" aria-labelledby="sideNavbarLabel">
        <div class="offcanvas-header" style="background-color: #FE5722;">
            <img src="../assets/img/logo.svg" class="me-2" alt="logo" style="height: 60px;">

            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link text-decoration-none text-dark fw-semibold"
                        href="index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link text-decoration-none text-dark fw-semibold"
                        href="archivedEvent.html">Archived Events</a></li>
                <li class="nav-item"><a class="nav-link text-decoration-none text-dark fw-semibold" href="myEvents.html">My
                        Events</a></li>
            </ul>
            <hr class=" d-lg-none"style="border-top: 2px solid #FE5722;">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link text-decoration-none text-dark fw-semibold d-lg-none" href="eventForm.html">Add Event</a>
                </li>
                <li class="nav-item">
                    <a class=" nav-link text-decoration-none text-dark fw-semibold d-lg-none" href="#" onclick="logout()">Log Out</a>
                </li>
            </ul>
        </div>
    </div>

    <div class="container d-flex justify-content-center mt-5">
        <div class="card cardDetails">
            <form id="editEventForm" enctype="multipart/form-data">
                <div class="eventFormTitle">Edit Event</div>

                <div class="row">
                    <div class="col-md-6">
                        <label>Event Name</label>
                        <input type="text" class="form-control" name="eventName" id="eventName" required>
                    </div>
                    <div class="col-md-6">
                        <label>Event Category</label>
                        <select class="form-control" name="eventCategory" id="eventCategory" required>
                            <option value="Concerts & Music">Concerts & Music</option>
                            <option value="Festivals & Fairs">Festivals & Fairs</option>
                            <option value="Sports & Fitness">Sports & Fitness</option>
                            <option value="Conferences & Seminars">Conferences & Seminars</option>
                            <option value="Workshops & Training">Workshops & Training</option>
                        </select>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-6">
                        <label>Age Requirement</label>
                        <select class="form-control" name="ageRequirement" id="ageRequirement" required>
                            <option value="Open to All Ages">Open to All Ages</option>
                            <option value="Under 12">Under 12</option>
                            <option value="13 - 17">13 - 17</option>
                            <option value="18 - 24">18 - 24</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label>Max Number of Attendees</label>
                        <input type="number" class="form-control" name="numberOfAttendees" id="numberOfAttendees" required>
                    </div>
                </div>

                <div class="mt-3">
                    <label>Description</label>
                    <textarea class="form-control" name="eventDescription" id="eventDescription" required></textarea>
                </div>

                <div class="row mt-3">
                    <div class="col-md-4">
                        <label>Date</label>
                        <input type="date" class="form-control" name="eventDate" id="eventDate" required>
                    </div>
                    <div class="col-md-4">
                        <label>Start Time</label>
                        <input type="time" class="form-control" name="eventStartTime" id="eventStartTime" required>
                    </div>
                    <div class="col-md-4">
                        <label>End Time</label>
                        <input type="time" class="form-control" name="eventEndTime" id="eventEndTime" required>
                    </div>
                </div>

                <div class="mt-3">
                    <label>Event Location</label>
                    <input type="text" class="form-control" name="eventLocation" id="eventLocation" readonly>
                    <input type="hidden" name="latitude" id="latitude">
                    <input type="hidden" name="longitude" id="longitude">
                </div>

                <div class="mt-3">
                    <div id="map" style="height: 300px;"></div>
                </div>

                <div class="mt-3">
                    <label>Upload Image</label>
                    <input type="file" name="imgFile" class="form-control" accept=".png,.jpg,.jpeg" id="imgFile">
                    <img id="currentImage" alt="Current Image" class="mt-2" style="max-width: 200px; display: none;">
                </div>

                <div class="mt-4 text-center">
                    <button type="submit" name="updateEvent" class="btn text-white" style="background-color: var(--c-primary-orange);">Update Event</button>
                    <a href="index.html" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../assets/js/data.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let currentEvent = null;
        let map, marker;

        document.addEventListener('DOMContentLoaded', function() {
            if (!session.requireAuth()) {
                return;
            }

            loadEventForEditing();
            initializeMap();
        });

        function loadEventForEditing() {
            // Get event ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('eventId');

            if (!eventId) {
                alert('No event ID provided');
                window.location.href = 'myEvents.html';
                return;
            }

            // Find event by ID (from sample data or user events)
            currentEvent = sampleEvents.find(event => event.id == eventId);
            
            if (!currentEvent) {
                // Check user's events
                const myEvents = sampleEvents.filter(event => 
                    event.organizerId === session.currentUser.organizerId
                );
                currentEvent = myEvents.find(event => event.id == eventId);
            }

            if (!currentEvent) {
                alert('Event not found');
                window.location.href = 'myEvents.html';
                return;
            }

            // Populate form with event data
            document.getElementById('eventName').value = currentEvent.eventName || '';
            document.getElementById('eventCategory').value = currentEvent.category || '';
            document.getElementById('ageRequirement').value = currentEvent.ageRequirement || 'Open to All Ages';
            document.getElementById('numberOfAttendees').value = currentEvent.numberOfAttendees || 50;
            document.getElementById('eventDescription').value = currentEvent.description || '';
            document.getElementById('eventDate').value = currentEvent.eventDate || '';
            document.getElementById('eventStartTime').value = currentEvent.startTime || '';
            document.getElementById('eventEndTime').value = currentEvent.endTime || '';
            document.getElementById('eventLocation').value = currentEvent.location || '';
            
            // Set coordinates (default to Manila if not present)
            const lat = currentEvent.latitude || 14.5995;
            const lng = currentEvent.longitude || 120.9842;
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;

            // Show current image if exists
            if (currentEvent.eventImage) {
                const imgElement = document.getElementById('currentImage');
                imgElement.src = `../assets/uploads/${currentEvent.eventImage}`;
                imgElement.style.display = 'block';
            }
        }

        function initializeMap() {
            const lat = parseFloat(document.getElementById('latitude').value) || 14.5995;
            const lng = parseFloat(document.getElementById('longitude').value) || 120.9842;

            map = L.map('map').setView([lat, lng], 15);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
            
            marker = L.marker([lat, lng]).addTo(map);

            map.on('click', function (e) {
                const newLat = e.latlng.lat;
                const newLng = e.latlng.lng;

                marker.setLatLng([newLat, newLng]);
                document.getElementById('latitude').value = newLat;
                document.getElementById('longitude').value = newLng;

                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${newLat}&lon=${newLng}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById("eventLocation").value = data.display_name;
                    })
                    .catch(error => {
                        console.error('Error getting address:', error);
                    });
            });
        }

        // Handle form submission
        document.getElementById('editEventForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                id: currentEvent.id,
                eventName: document.getElementById('eventName').value,
                category: document.getElementById('eventCategory').value,
                ageRequirement: document.getElementById('ageRequirement').value,
                numberOfAttendees: document.getElementById('numberOfAttendees').value,
                description: document.getElementById('eventDescription').value,
                eventDate: document.getElementById('eventDate').value,
                startTime: document.getElementById('eventStartTime').value,
                endTime: document.getElementById('eventEndTime').value,
                location: document.getElementById('eventLocation').value,
                latitude: document.getElementById('latitude').value,
                longitude: document.getElementById('longitude').value
            };

            // Update event in sample data
            const eventIndex = sampleEvents.findIndex(event => event.id === currentEvent.id);
            if (eventIndex > -1) {
                sampleEvents[eventIndex] = { ...sampleEvents[eventIndex], ...formData };
            }

            alert('Event updated successfully!');
            window.location.href = 'myEvents.html';
        });

        function logout() {
            session.logout();
            window.location.href = '../login.html';
        }
    </script>
</body>

</html>
